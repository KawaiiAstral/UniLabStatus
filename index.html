<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Status</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --color-operational: #2fcc66;
            --color-degraded: #f1c40f;
            --color-outage: #e74c3c;
            --bg-color: #ffffff;
            --text-main: #333;
            --border-color: #e0e0e0;
        }
        body { font-family: 'Inter', sans-serif; background-color: #fcfcfc; color: var(--text-main); margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .layout-container { width: 100%; max-width: 860px; padding: 40px 20px; }
        
        header { margin-bottom: 30px; }
        .logo { font-size: 1.8rem; font-weight: 600; color: #172b4d; }

        .overall-status { background-color: var(--color-operational); color: white; padding: 16px 24px; border-radius: 4px; font-weight: 600; font-size: 1.2rem; display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        
        .components-container { border: 1px solid var(--border-color); border-radius: 4px; background: white; overflow: hidden; }
        
        .component-item { padding: 20px 24px; border-bottom: 1px solid var(--border-color); }
        .component-item:last-child { border-bottom: none; }
        
        .component-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .component-name { font-size: 1rem; font-weight: 600; }
        .component-status { font-size: 0.9rem; }
        
        /* 履歴バーのスタイル */
        .history-bar { display: flex; gap: 2px; height: 30px; align-items: flex-end; }
        .history-segment { flex: 1; background-color: #eee; border-radius: 2px; min-width: 4px; transition: all 0.2s; position: relative; }
        /* ツールチップ */
        .history-segment:hover::after {
            content: attr(data-title);
            position: absolute; bottom: 35px; left: 50%; transform: translateX(-50%);
            background: #333; color: #fff; padding: 4px 8px; font-size: 10px; border-radius: 4px; white-space: nowrap; z-index: 10;
        }
        
        .status-bg-operational { background-color: var(--color-operational); }
        .status-bg-down { background-color: var(--color-outage); }
        .status-text-operational { color: var(--color-operational); }
        .status-text-down { color: var(--color-outage); }

        footer { margin-top: 50px; font-size: 0.8rem; color: #7e8c8d; text-align: center; }
    </style>
</head>
<body>

<div class="layout-container">
    <header><div class="logo">System Status</div></header>

    <div id="overall-bar" class="overall-status">
        <span>Loading...</span>
    </div>

    <div class="components-container" id="component-list"></div>

    <footer>
        <p id="last-updated">Last updated: --</p>
    </footer>
</div>
<script>
    async function fetchStatus() {
        try {
            const response = await fetch('./status.json?t=' + new Date().getTime());
            const data = await response.json();
            render(data);
        } catch (error) {
            console.error(error);
            // エラー時はローディング表示を更新
            document.getElementById('overall-bar').innerHTML = '<span>Failed to load status</span>';
            document.getElementById('overall-bar').style.backgroundColor = '#95a5a6';
        }
    }

    function render(data) {
        const list = document.getElementById('component-list');
        const overallBar = document.getElementById('overall-bar');
        const lastUpdatedLabel = document.getElementById('last-updated');

        if(lastUpdatedLabel) {
            lastUpdatedLabel.textContent = `Last updated: ${data.lastUpdated}`;
        }
        
        list.innerHTML = '';
        let globalStatus = 'operational';

        // データが空の場合のガード
        if (!data.services) {
            list.innerHTML = '<div style="padding:20px; text-align:center;">No service data found.</div>';
            return;
        }

        data.services.forEach(service => {
            // 現在のステータス
            const isUp = service.currentStatus === 'operational';
            if (!isUp) globalStatus = 'down';

            // ★ここが修正ポイント★
            // historyがない(undefined)場合は、空の配列 [] を代わりに入れる
            const history = service.history || [];
            
            // 履歴バーの生成
            const historyToShow = history.slice(0, 40).reverse(); 
            
            let barsHtml = historyToShow.map(log => {
                const date = new Date(log.time);
                const timeStr = date.getHours() + ':' + date.getMinutes().toString().padStart(2, '0');
                const colorClass = log.status === 'operational' ? 'status-bg-operational' : 'status-bg-down';
                let height = '100%'; 
                
                return `<div class="history-segment ${colorClass}" style="height: ${height};" data-title="${timeStr} - ${log.status}"></div>`;
            }).join('');

            // 足りない分をグレーで埋める
            const emptyCount = 40 - historyToShow.length;
            for(let i=0; i<emptyCount; i++) {
                barsHtml = `<div class="history-segment" style="background-color:#eee;"></div>` + barsHtml;
            }

            const html = `
                <div class="component-item">
                    <div class="component-header">
                        <span class="component-name">${service.name}</span>
                        <span class="component-status ${isUp ? 'status-text-operational' : 'status-text-down'}">
                            ${isUp ? 'Operational' : 'Major Outage'}
                        </span>
                    </div>
                    <div class="history-bar">
                        ${barsHtml}
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:0.7em; color:#aaa; margin-top:4px;">
                        <span>Past</span>
                        <span>Now</span>
                    </div>
                </div>
            `;
            list.innerHTML += html;
        });

        // 全体バーの更新
        if (globalStatus === 'operational') {
            overallBar.style.backgroundColor = 'var(--color-operational)';
            overallBar.innerHTML = 'All Systems Operational <i class="fas fa-check-circle"></i>';
        } else {
            overallBar.style.backgroundColor = 'var(--color-outage)';
            overallBar.innerHTML = 'Some systems are down <i class="fas fa-exclamation-triangle"></i>';
        }
    }

    fetchStatus();
</script>

</body>
</html>
